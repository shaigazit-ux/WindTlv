<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>תל אביב קייט | מדידות חוף</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
*{font-family:'Assistant',sans-serif}
:root{
  --bg:#eaf6ff;
  --card:#fff;
  --text:#0f172a;
  --muted:#475569;
  --border:#cbd5e1;
  --brand:#0284c7;
  --accent:#0ea5e9;
}
body{
  background:linear-gradient(#f0f9ff,#e0f2fe);
  color:var(--text);
}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  box-shadow:0 10px 30px rgba(2,132,199,.1);
}
.badge{
  font-size:.7rem;
  background:#e0f2fe;
  color:var(--brand);
  padding:.2rem .6rem;
  border-radius:999px;
}
.chart-shell{
  background:#f8fafc;
  border:1px solid var(--border);
  border-radius:14px;
  height:260px;
  padding:10px;
}
.table-tight th,.table-tight td{
  padding:.3rem .4rem;
  font-size:.8rem;
}
</style>
</head>

<body class="px-4 py-6">
<header class="max-w-6xl mx-auto mb-4 flex justify-between items-center">
  <div>
    <h1 class="text-2xl font-extrabold">תל אביב קייט</h1>
    <p class="text-sm text-slate-500">ממוצע משוקלל • חיישנים חיים</p>
  </div>
  <span class="badge">LIVE</span>
</header>

<main class="max-w-6xl mx-auto space-y-6">

<div class="card p-6">
  <h2 class="font-bold mb-2">גרף רוח – 24 שעות</h2>
  <div class="chart-shell">
    <canvas id="windChart"></canvas>
  </div>
</div>

<div class="card p-6">
  <h2 class="font-bold mb-2">חיישנים פעילים (20–30 ק״מ)</h2>
  <ul class="text-sm text-slate-600 list-disc pr-5">
    <li>OpenWeather – הילטון / קלור / יפו</li>
    <li>Open-Meteo – הרצליה, בת ים, ראשל״צ</li>
    <li>METAR – נתב״ג (LLBG)</li>
  </ul>
</div>

<div class="card p-6">
  <h2 class="font-bold mb-3">נתונים אחרונים</h2>
  <div class="overflow-x-auto">
    <table class="w-full table-tight text-right">
      <thead class="border-b text-slate-500">
        <tr>
          <th>שעה</th><th>רוח</th><th>משבים</th><th class="text-center">כיוון</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>
</div>

</main>

<script>
const KNOTS=1.94384;
const state={readings:[]};
let chart=null;

/* ===== Wind zones plugin ===== */
const windZonesPlugin={
 id:'windZones',
 beforeDraw(chart){
  const{ctx,chartArea,scales}=chart;
  if(!chartArea)return;
  const y=scales.y;
  const zones=[
   {f:0,t:10,c:'rgba(148,163,184,.18)'},
   {f:10,t:15,c:'rgba(34,197,94,.14)'},
   {f:15,t:20,c:'rgba(59,130,246,.14)'},
   {f:20,t:25,c:'rgba(245,158,11,.14)'},
   {f:25,t:60,c:'rgba(239,68,68,.12)'}
  ];
  ctx.save();
  ctx.rect(chartArea.left,chartArea.top,chartArea.right-chartArea.left,chartArea.bottom-chartArea.top);
  ctx.clip();
  zones.forEach(z=>{
    ctx.fillStyle=z.c;
    ctx.fillRect(chartArea.left,y.getPixelForValue(z.t),chartArea.right-chartArea.left,y.getPixelForValue(z.f)-y.getPixelForValue(z.t));
  });
  ctx.restore();
 }
};

function ensureChart(){
 if(chart)return;
 chart=new Chart(document.getElementById('windChart'),{
  type:'line',
  data:{labels:[],datasets:[
   {label:'רוח (קשר)',data:[],borderWidth:2,pointRadius:0,fill:true,
    backgroundColor:(ctx)=>{
      const g=ctx.chart.ctx.createLinearGradient(0,0,0,200);
      g.addColorStop(0,'rgba(2,132,199,.25)');
      g.addColorStop(1,'rgba(2,132,199,.03)');
      return g;
    }},
   {label:'משבים',data:[],borderWidth:2,pointRadius:0,borderDash:[6,4]}
  ]},
  options:{
   responsive:true,
   maintainAspectRatio:false,
   scales:{y:{beginAtZero:true,title:{display:true,text:'קשר'}}},
   interaction:{mode:'index',intersect:false}
  },
  plugins:[windZonesPlugin]
 });
}

/* ===== Helpers ===== */
function msToKnots(ms){return ms*KNOTS}
function avgDir(degs){
 let x=0,y=0;
 degs.forEach(d=>{x+=Math.cos(d*Math.PI/180);y+=Math.sin(d*Math.PI/180)});
 return(Math.atan2(y,x)*180/Math.PI+360)%360;
}

/* ===== Fetch sensors ===== */
async function fetchSensors(){
 const sensors=[];

 /* OpenWeather (3 points) */
 const owPts=[
  [32.1101,34.7795],[32.0631,34.7636],[32.05,34.75]
 ];
 for(const[pLat,pLon] of owPts){
  const r=await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${pLat}&lon=${pLon}&appid=0429ca60a348cdac63a6cc4547a6837d&units=metric`);
  const j=await r.json();
  sensors.push({w:j.wind.speed,g:j.wind.gust||j.wind.speed*1.2,d:j.wind.deg,weight:.15});
 }

 /* Open-Meteo (3 points) */
 const omPts=[[32.16,34.83],[32.02,34.75],[31.98,34.78]];
 for(const[pLat,pLon] of omPts){
  const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${pLat}&longitude=${pLon}&current=wind_speed_10m,wind_direction_10m,wind_gusts_10m`);
  const j=await r.json();
  sensors.push({
   w:j.current.wind_speed_10m,
   g:j.current.wind_gusts_10m||j.current.wind_speed_10m*1.2,
   d:j.current.wind_direction_10m,
   weight:.13
  });
 }

 /* METAR LLBG */
 const mr=await fetch(`https://aviationweather.gov/api/data/metar?ids=LLBG&format=json`);
 const mj=(await mr.json())[0];
 if(mj){
  sensors.push({
   w:mj.wspd*0.514,
   g:mj.wgst?mj.wgst*0.514:mj.wspd*0.6,
   d:mj.wdir,
   weight:.15
  });
 }

 return sensors;
}

/* ===== Main tick ===== */
async function tick(){
 const sensors=await fetchSensors();
 let sw=0,sg=0,sd=[],tw=0;
 sensors.forEach(s=>{
  sw+=s.w*s.weight;
  sg+=s.g*s.weight;
  sd.push(s.d);
  tw+=s.weight;
 });
 const rec={
  t:new Date(),
  w:msToKnots(sw/tw),
  g:msToKnots(sg/tw),
  d:avgDir(sd)
 };
 state.readings.push(rec);
 if(state.readings.length>1440)state.readings.shift();
 render();
}

function render(){
 ensureChart();
 const data=state.readings.slice(-240);
 chart.data.labels=data.map(r=>r.t.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'}));
 chart.data.datasets[0].data=data.map(r=>r.w);
 chart.data.datasets[1].data=data.map(r=>r.g);
 chart.update('none');

 document.getElementById('tableBody').innerHTML=data.slice(-10).reverse().map(r=>`
  <tr>
   <td>${r.t.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'})}</td>
   <td>${r.w.toFixed(1)}</td>
   <td class="text-orange-600">${r.g.toFixed(1)}</td>
   <td class="text-center"><i class="fas fa-arrow-up" style="transform:rotate(${r.d}deg)"></i></td>
  </tr>
 `).join('');
}

tick();
setInterval(tick,60000);
</script>
</body>
</html>
