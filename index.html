<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>תל אביב קייט | מדידות חוף</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    * { font-family: 'Assistant', sans-serif; }

    :root{
      --bg1:#f0f9ff;
      --bg2:#e0f2fe;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --border:#cbd5e1;
      --brand:#0284c7;
      --brand2:#0ea5e9;
      --wind:#0369a1;
    }

    body{
      background: linear-gradient(180deg,var(--bg1),var(--bg2));
      color: var(--text);
      min-height: 100vh;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(2,132,199,.10);
    }

    .badge{
      font-size:.72rem;
      background:#e0f2fe;
      color: var(--brand);
      padding:.18rem .55rem;
      border-radius: 999px;
      border: 1px solid rgba(2,132,199,.22);
      display:inline-flex;
      align-items:center;
      gap:.35rem;
      white-space: nowrap;
    }

    .btn{
      background: rgba(2,132,199,.12);
      border: 1px solid rgba(2,132,199,.22);
      color: var(--brand);
      padding: .45rem .7rem;
      border-radius: 12px;
      transition: .2s;
      display:inline-flex;
      align-items:center;
      gap:.45rem;
      font-weight: 800;
      font-size: .9rem;
    }
    .btn:hover{ background: rgba(2,132,199,.18); }
    .btn:active{ transform: translateY(1px); }

    /* ===== Compass ===== */
    .compass{
      width: 148px;
      height: 148px;
      border-radius: 50%;
      border: 2px solid var(--border);
      background: #f8fafc;
      position: relative;
      box-shadow: inset 0 0 0 10px rgba(14,165,233,.08);
    }
    .compass::after{
      content:"";
      position:absolute;
      inset:14px;
      border-radius:50%;
      border:1px dashed #94a3b8;
    }
    .compass-degree{
      position:absolute;
      font-size:.68rem;
      color:#64748b;
      font-weight:800;
      background: rgba(255,255,255,.88);
      border:1px solid rgba(203,213,225,.8);
      padding:.05rem .28rem;
      border-radius: 8px;
    }
    .deg-n{top:6px;left:50%;transform:translateX(-50%)}
    .deg-e{right:6px;top:50%;transform:translateY(-50%)}
    .deg-s{bottom:6px;left:50%;transform:translateX(-50%)}
    .deg-w{left:6px;top:50%;transform:translateY(-50%)}

    .compass-arrow{
      position:absolute;
      bottom:50%;
      left:50%;
      width: 5px;
      height: 54px;
      border-radius: 999px;
      background: linear-gradient(to top,var(--brand2),var(--brand));
      transform-origin: bottom center;
      transform: translateX(-50%) rotate(0deg);
      box-shadow: 0 6px 12px rgba(2,132,199,.22);
    }
    .compass-arrow::after{
      content:"";
      position:absolute;
      top:-10px;
      left:50%;
      transform: translateX(-50%);
      border-left:9px solid transparent;
      border-right:9px solid transparent;
      border-bottom:12px solid var(--brand);
    }

    /* ===== Interval buttons ===== */
    .seg{
      background: rgba(148,163,184,.20);
      border: 1px solid rgba(148,163,184,.35);
      border-radius: 999px;
      padding: .2rem;
      display:inline-flex;
      gap:.25rem;
    }
    .seg button{
      padding:.38rem .7rem;
      border-radius: 999px;
      font-weight: 900;
      font-size: .85rem;
      color: #334155;
      transition:.15s;
      border:1px solid transparent;
    }
    .seg button.active{
      background: #ffffff;
      border-color: rgba(2,132,199,.25);
      color: var(--brand);
      box-shadow: 0 6px 16px rgba(2,132,199,.12);
    }

    /* ===== Chart container ===== */
    .chart-shell{
      background: #f8fafc;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px;
      height: 280px;
      box-shadow: inset 0 0 0 1px rgba(15,23,42,.02);
    }
    @media(max-width:640px){
      .chart-shell{ height: 240px; }
    }

    /* ===== Tight table ===== */
    .table-tight th, .table-tight td{
      padding: .28rem .42rem;
      font-size: .82rem;
      vertical-align: middle;
    }
    @media (max-width: 640px){
      .table-tight th, .table-tight td{ font-size: .72rem; padding: .25rem .34rem; }
    }

    .mini-pill{
      border:1px solid rgba(2,132,199,.20);
      background: rgba(2,132,199,.08);
      color:#0b5b88;
      border-radius: 999px;
      padding:.2rem .55rem;
      font-size: .78rem;
      font-weight: 800;
      display:inline-flex;
      align-items:center;
      gap:.35rem;
      white-space: nowrap;
    }

    /* sensor cards */
    .sensor-title { font-size: .78rem; color: #64748b; font-weight: 800; }
    .sensor-speed { font-size: 1.55rem; font-weight: 900; color: #075985; line-height: 1.1; }
    .sensor-sub { font-size: .78rem; color:#64748b; display:flex; align-items:center; justify-content:space-between; gap:.5rem; }
    .dir-chip { display:inline-flex; align-items:center; gap:.35rem; }
    .dir-arrow { color:#0284c7; display:inline-block; }

    /* ===== Decision bar ===== */
    .go-light{
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 2px solid rgba(15,23,42,.15);
      box-shadow: 0 6px 18px rgba(15,23,42,.08);
    }
    .go-light.green{ background: #22c55e; }
    .go-light.yellow{ background: #f59e0b; }
    .go-light.red{ background: #ef4444; }

    /* ===== Modal ===== */
    .modal{
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,.45);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal.hidden{ display:none; }
    .modal-card{
      width: min(680px, 100%);
    }
  </style>
</head>

<body class="px-4 py-6">
  <header class="max-w-6xl mx-auto mb-5 flex items-center justify-between gap-3">
    <div>
      <h1 class="text-2xl font-extrabold tracking-tight">תל אביב קייט</h1>
      <div class="flex items-center gap-2 mt-1 flex-wrap">
        <span class="badge"><span class="w-2 h-2 rounded-full bg-emerald-500 inline-block"></span>LIVE</span>
        <span class="text-sm text-slate-500">שעון: <span id="israelTime" class="font-mono text-slate-700">--:--:--</span></span>
        <span class="text-sm text-slate-400">• ממוצע משוקלל</span>
      </div>
    </div>

    <button onclick="fetchLiveData()" class="btn">
      <i class="fas fa-rotate" id="refreshIcon"></i>
      רענון
    </button>
  </header>

  <!-- Decision Bar -->
  <section class="max-w-6xl mx-auto mb-5">
    <div class="card p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">

      <div class="flex items-center gap-3">
        <div id="goLight" class="go-light red" title="מצב יציאה"></div>
        <div>
          <div id="goTitle" class="text-lg font-extrabold">—</div>
          <div id="goSubtitle" class="text-sm text-slate-500">—</div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div class="text-sm">
          <div class="font-extrabold text-slate-700">
            אמון: <span id="confidenceScore">—</span>
          </div>
          <div id="confidenceMeta" class="text-xs text-slate-400">—</div>
        </div>

        <button id="openPrefsBtn" class="btn">
          <i class="fas fa-sliders"></i>
          התאמה
        </button>
      </div>

    </div>
  </section>

  <main class="max-w-6xl mx-auto space-y-6">

    <!-- Dashboard -->
    <section class="card p-5 md:p-6 grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="md:col-span-2">
        <p class="text-sm text-slate-500 mb-1">מהירות רוח ממוצעת</p>
        <div class="flex items-end gap-3">
          <span id="currentSpeed" class="text-6xl font-extrabold" style="color:var(--wind)">--</span>
          <span class="text-xl mb-1 font-bold">קשר</span>
        </div>
        <p class="text-xs text-slate-500 mt-1">המרה: m/s × 1.94</p>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-5 text-center">
          <div class="card !shadow-none p-3" style="border-radius:14px">
            <p class="text-xs text-slate-500">כיוון</p>
            <p id="windDir" class="font-extrabold">--</p>
          </div>
          <div class="card !shadow-none p-3" style="border-radius:14px">
            <p class="text-xs text-slate-500">משבים</p>
            <p id="windGust" class="font-extrabold text-orange-600">--</p>
          </div>
          <div class="card !shadow-none p-3" style="border-radius:14px">
            <p class="text-xs text-slate-500">מים</p>
            <p id="waterTempMain" class="font-extrabold text-teal-700">--</p>
          </div>
          <div class="card !shadow-none p-3" style="border-radius:14px">
            <p class="text-xs text-slate-500">חוף</p>
            <p id="temp" class="font-extrabold">--</p>
          </div>
        </div>

        <div class="mt-5 flex flex-wrap gap-2">
          <span class="mini-pill"><i class="fas fa-cloud"></i> OWM חוף</span>
          <span class="mini-pill"><i class="fas fa-satellite"></i> Open-Meteo</span>
          <span class="mini-pill"><i class="fas fa-plane"></i> נתב״ג METAR</span>
          <span class="mini-pill"><i class="fas fa-water"></i> מצב הים</span>
        </div>
      </div>

      <div class="flex items-center justify-center">
        <div class="compass" title="כיוון רוח (מעלות)">
          <div class="compass-degree deg-n">0°</div>
          <div class="compass-degree deg-e">90°</div>
          <div class="compass-degree deg-s">180°</div>
          <div class="compass-degree deg-w">270°</div>
          <div id="compassArrow" class="compass-arrow"></div>
        </div>
      </div>
    </section>

    <!-- Sea / temps -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="card p-4">
        <div class="flex items-center justify-between gap-2">
          <p class="text-sm font-extrabold">גובה גלים</p>
          <span class="badge" id="waveSourceBadge">טוען…</span>
        </div>
        <div class="mt-2 flex items-end gap-2">
          <span id="waveHeight" class="text-4xl font-extrabold text-amber-600">--</span>
          <span class="text-sm text-slate-500 mb-1">מ׳</span>
        </div>
        <p id="waveRangeText" class="text-xs text-slate-500 mt-2">--</p>
      </div>

      <div class="card p-4">
        <p class="text-sm font-extrabold">טמפרטורת מים</p>
        <p id="waterTempSide" class="text-4xl font-extrabold text-teal-700 mt-2">--</p>
        <p class="text-xs text-slate-500 mt-2">SST</p>
      </div>
    </section>

    <!-- OWM coastal sensors -->
    <section class="card p-5 md:p-6">
      <div class="flex items-center justify-between gap-3 mb-4">
        <div>
          <h2 class="text-lg font-extrabold">חיישני חוף</h2>
          <p class="text-sm text-slate-500">מהירות / משבים / כיוון</p>
        </div>
        <span class="badge">OWM</span>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="card !shadow-none p-4" style="border-radius:14px">
          <div class="sensor-title">הילטון (צפון)</div>
          <div class="sensor-speed"><span id="speed1">--</span> <span class="text-base font-extrabold text-slate-700">קשר</span></div>
          <div class="sensor-sub mt-2">
            <span>משבים: <span id="gust1" class="font-extrabold text-orange-600">--</span></span>
            <span class="dir-chip">
              <i class="fas fa-arrow-up dir-arrow" id="dirIcon1" style="transform:rotate(0deg)"></i>
            </span>
          </div>
        </div>

        <div class="card !shadow-none p-4" style="border-radius:14px">
          <div class="sensor-title">צ'רלס קלור (מרכז)</div>
          <div class="sensor-speed"><span id="speed2">--</span> <span class="text-base font-extrabold text-slate-700">קשר</span></div>
          <div class="sensor-sub mt-2">
            <span>משבים: <span id="gust2" class="font-extrabold text-orange-600">--</span></span>
            <span class="dir-chip">
              <i class="fas fa-arrow-up dir-arrow" id="dirIcon2" style="transform:rotate(0deg)"></i>
            </span>
          </div>
        </div>

        <div class="card !shadow-none p-4" style="border-radius:14px">
          <div class="sensor-title">יפו (דרום)</div>
          <div class="sensor-speed"><span id="speed3">--</span> <span class="text-base font-extrabold text-slate-700">קשר</span></div>
          <div class="sensor-sub mt-2">
            <span>משבים: <span id="gust3" class="font-extrabold text-orange-600">--</span></span>
            <span class="dir-chip">
              <i class="fas fa-arrow-up dir-arrow" id="dirIcon3" style="transform:rotate(0deg)"></i>
            </span>
          </div>
        </div>
      </div>
    </section>

    <!-- Extra sensors -->
    <section class="card p-5 md:p-6">
      <div class="flex items-center justify-between gap-3 mb-4">
        <div>
          <h2 class="text-lg font-extrabold">חיישנים נוספים</h2>
          <p class="text-sm text-slate-500">Open-Meteo + נתב״ג</p>
        </div>
        <span class="badge">LIVE</span>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="card !shadow-none p-4" style="border-radius:14px">
          <div class="sensor-title">הרצליה (OM)</div>
          <div class="sensor-speed"><span id="omHerzliya">--</span> <span class="text-base font-extrabold text-slate-700">קשר</span></div>
          <div class="sensor-sub mt-2">
            <span>משבים: <span id="omHerzliyaGust" class="font-extrabold text-orange-600">--</span></span>
            <i class="fas fa-arrow-up dir-arrow" id="omHerzliyaDir" style="transform:rotate(0deg)"></i>
          </div>
        </div>

        <div class="card !shadow-none p-4" style="border-radius:14px">
          <div class="sensor-title">בת ים (OM)</div>
          <div class="sensor-speed"><span id="omBatYam">--</span> <span class="text-base font-extrabold text-slate-700">קשר</span></div>
          <div class="sensor-sub mt-2">
            <span>משבים: <span id="omBatYamGust" class="font-extrabold text-orange-600">--</span></span>
            <i class="fas fa-arrow-up dir-arrow" id="omBatYamDir" style="transform:rotate(0deg)"></i>
          </div>
        </div>

        <div class="card !shadow-none p-4" style="border-radius:14px">
          <div class="sensor-title">ראשל״צ (OM)</div>
          <div class="sensor-speed"><span id="omRishon">--</span> <span class="text-base font-extrabold text-slate-700">קשר</span></div>
          <div class="sensor-sub mt-2">
            <span>משבים: <span id="omRishonGust" class="font-extrabold text-orange-600">--</span></span>
            <i class="fas fa-arrow-up dir-arrow" id="omRishonDir" style="transform:rotate(0deg)"></i>
          </div>
        </div>

        <div class="card !shadow-none p-4" style="border-radius:14px">
          <div class="sensor-title">נתב״ג (LLBG)</div>
          <div class="sensor-speed"><span id="metarLLBG">--</span> <span class="text-base font-extrabold text-slate-700">קשר</span></div>
          <div class="sensor-sub mt-2">
            <span>משבים: <span id="metarLLBGGust" class="font-extrabold text-orange-600">--</span></span>
            <i class="fas fa-arrow-up dir-arrow" id="metarLLBGDir" style="transform:rotate(0deg)"></i>
          </div>
        </div>
      </div>
    </section>

    <!-- History -->
    <section class="card p-5 md:p-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
        <div>
          <h2 class="text-lg font-extrabold">גרף רוח (24 שעות)</h2>
          <p class="text-sm text-slate-500">רצועות צבע לפי עוצמה + מהירות/משבים</p>
        </div>

        <div class="seg">
          <button id="btn-1min" onclick="setIntervalMode('1min')">כל דקה</button>
          <button id="btn-15min" class="active" onclick="setIntervalMode('15min')">15 דקות</button>
        </div>
      </div>

      <div class="chart-shell mb-6">
        <canvas id="windChart" aria-label="Wind chart" role="img"></canvas>
      </div>

      <div class="overflow-x-auto">
        <table class="w-full text-right table-tight">
          <thead class="text-slate-500 border-b border-slate-200">
            <tr>
              <th class="whitespace-nowrap">שעה</th>
              <th class="whitespace-nowrap">רוח</th>
              <th class="whitespace-nowrap">משבים</th>
              <th class="text-center whitespace-nowrap">כיוון</th>
              <th class="whitespace-nowrap">גל</th>
              <th class="whitespace-nowrap">מים</th>
            </tr>
          </thead>
          <tbody id="recentHoursTable">
            <tr><td colspan="6" class="text-center py-6 text-slate-400">אין נתונים</td></tr>
          </tbody>
        </table>
      </div>
    </section>

  </main>
  <!-- Preferences Modal -->
  <div id="prefsModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-card card p-5">
      <div class="flex items-center justify-between gap-3 mb-4">
        <h3 class="text-lg font-extrabold">התאמה אישית</h3>
        <button id="closePrefsBtn" class="btn" style="padding:.35rem .55rem">
          <i class="fas fa-xmark"></i>
        </button>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <label class="text-sm font-extrabold text-slate-700">
          משקל (ק״ג)
          <input id="prefWeight" type="number" min="40" max="120" step="1"
                 class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2"
                 value="75"/>
        </label>

        <label class="text-sm font-extrabold text-slate-700">
          ענף
          <select id="prefDiscipline"
                  class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2">
            <option value="tt">טווינטיפ</option>
            <option value="wave">גלים</option>
            <option value="foil">פויל</option>
          </select>
        </label>

        <label class="text-sm font-extrabold text-slate-700">
          גודל קייט (מ״ר)
          <input id="prefKite" type="number" min="5" max="15" step="1"
                 class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2"
                 value="12"/>
        </label>

        <label class="text-sm font-extrabold text-slate-700">
          מינימום רוח (קשר) (אופציונלי)
          <input id="prefMinWind" type="number" min="5" max="45" step="0.5"
                 class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2"
                 placeholder="לדוגמה 14"/>
        </label>
      </div>

      <div class="flex items-center justify-end gap-2 mt-5">
        <button id="resetPrefsBtn" class="btn">
          <i class="fas fa-rotate-left"></i>
          איפוס
        </button>
        <button id="savePrefsBtn" class="btn" style="background:rgba(34,197,94,.14);border-color:rgba(34,197,94,.35);color:#047857">
          <i class="fas fa-check"></i>
          שמור
        </button>
      </div>
    </div>
  </div>

<script>
  const OWM_API_KEY = '0429ca60a348cdac63a6cc4547a6837d';
  const KNOTS = 1.94384;
  const ISRAEL_TZ = 'Asia/Jerusalem';

  // Wave + SST fallback point (marine)
  const WAVE_COORDS = { lat: 32.1656, lon: 34.8368 };

  // Tel Aviv municipality sea-state page (contains: "גובה הגלים: 50 - 130 ס\"מ")
  const TLV_SEA_PAGE = 'https://www.tel-aviv.gov.il/Visitors/Pages/TelAvivBeach.aspx';
  const JINA_PROXY = (url) => `https://r.jina.ai/${url}`;

  // Base 3 coastal points (OWM)
  const windSensorsOWM = [
    { id: 1, lat: 32.1101, lon: 34.7795, name: 'הילטון' },
    { id: 2, lat: 32.0631, lon: 34.7636, name: 'קלור' },
    { id: 3, lat: 32.0500, lon: 34.7500, name: 'יפו' }
  ];

  // Extra open sensors (Open-Meteo, no key)
  const openMeteoPoints = {
    herzliya: { lat: 32.1656, lon: 34.8368, label: 'הרצליה' },
    batyam:   { lat: 32.0167, lon: 34.7500, label: 'בת ים' },
    rishon:   { lat: 31.9870, lon: 34.7590, label: 'ראשל״צ' }
  };

  const state = {
    readings: [],
    currentInterval: '15min',
    liveCount: 0
  };

  // ===== Preferences + Decision =====
  const PREFS_KEY = "windtlv_prefs_v1";
  const defaultPrefs = { weightKg: 75, kiteM2: 12, discipline: "tt", minWind: null };

  function loadPrefs(){
    try{
      const raw = localStorage.getItem(PREFS_KEY);
      if (!raw) return { ...defaultPrefs };
      return { ...defaultPrefs, ...JSON.parse(raw) };
    }catch{
      return { ...defaultPrefs };
    }
  }
  function savePrefs(p){ localStorage.setItem(PREFS_KEY, JSON.stringify(p)); }

  function baseNeedKnotsByDiscipline(d){
    if (d === "foil") return 10;
    if (d === "wave") return 16;
    return 15; // tt
  }

  // קייט: 10–15 => 1 קשר לכל מטר (יחסית ל-12)
  // קייט: 5–9  => 2 קשר לכל מטר (אבל 12->10 עדיין 1 קשר/מטר)
  function kiteAdjustmentKnots(kiteM2){
    if (!Number.isFinite(kiteM2)) return 0;
    if (kiteM2 >= 10){
      return (12 - kiteM2) * 1;
    }
    return (12 - 10) * 1 + (10 - kiteM2) * 2;
  }

  function requiredWindKnots(prefs){
    const base = baseNeedKnotsByDiscipline(prefs.discipline);
    const weightAdj = (prefs.weightKg - 75) / 10; // +1 קשר לכל +10 ק"ג
    const kiteAdj = kiteAdjustmentKnots(prefs.kiteM2);

    let need = base + weightAdj + kiteAdj;
    if (Number.isFinite(prefs.minWind) && prefs.minWind > 0){
      need = Math.max(need, prefs.minWind);
    }
    return need;
  }

  function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
  function mean(arr){
    const xs = arr.filter(x => Number.isFinite(x));
    if (!xs.length) return null;
    return xs.reduce((s,x)=>s+x,0) / xs.length;
  }
  function stddev(arr){
    const xs = arr.filter(x => Number.isFinite(x));
    if (xs.length < 2) return 0;
    const m = mean(xs);
    const v = xs.reduce((s,x)=>s+(x-m)**2,0) / (xs.length - 1);
    return Math.sqrt(v);
  }

  function computeDecisionAndConfidence({ fusedAvgKnots, sensors, nowTs, prefs }){
    const need = requiredWindKnots(prefs);

    let stateLight = "red";
    if (fusedAvgKnots >= need + 1) stateLight = "green";
    else if (fusedAvgKnots >= need - 1) stateLight = "yellow";

    const title =
      stateLight === "green" ? "צא לחוף זריז" :
      stateLight === "yellow" ? "גבולי כרגע" :
      "טוב למטקות";

    const subtitle = `${fusedAvgKnots.toFixed(1)} קשר (יעד ~${need.toFixed(1)}) • ${prefs.discipline.toUpperCase()} • קייט ${prefs.kiteM2} • ${prefs.weightKg}kg`;

    const MAX_AGE_MIN = 20;
    const active = sensors
      .filter(s => Number.isFinite(s.avgKnots) && Number.isFinite(s.ts))
      .map(s => ({...s, ageMin: (nowTs - s.ts) / 60000 }))
      .filter(s => s.ageMin <= MAX_AGE_MIN);

    const nActive = active.length;
    const coverage = clamp(nActive / 4, 0, 1);

    const std = stddev(active.map(s => s.avgKnots));
    const agreement = clamp(1 - (std / 4), 0, 1);

    const maxAge = nActive ? Math.max(...active.map(s => s.ageMin)) : 999;
    const freshness = clamp(1 - (maxAge / 40), 0, 1);

    const confidence = Math.round(100 * (0.45*coverage + 0.40*agreement + 0.15*freshness));
    const confidenceMeta = nActive ? `${nActive} חיישנים • σ=${std.toFixed(1)} • ${Math.round(maxAge)}ד׳` : "אין חיישנים עדכניים";

    return { stateLight, title, subtitle, confidence, confidenceMeta };
  }

  function renderDecisionBar(res){
    const light = document.getElementById("goLight");
    const goTitle = document.getElementById("goTitle");
    const goSubtitle = document.getElementById("goSubtitle");
    const confScore = document.getElementById("confidenceScore");
    const confMeta = document.getElementById("confidenceMeta");
    if (!light) return;

    light.classList.remove("red","yellow","green");
    light.classList.add(res.stateLight);
    goTitle.textContent = res.title;
    goSubtitle.textContent = res.subtitle;
    confScore.textContent = `${res.confidence}%`;
    confMeta.textContent = res.confidenceMeta;
  }

  function openPrefs(){
    const p = loadPrefs();
    document.getElementById("prefWeight").value = p.weightKg;
    document.getElementById("prefKite").value = p.kiteM2;
    document.getElementById("prefDiscipline").value = p.discipline;
    document.getElementById("prefMinWind").value = (p.minWind ?? "");
    document.getElementById("prefsModal").classList.remove("hidden");
  }
  function closePrefs(){
    document.getElementById("prefsModal").classList.add("hidden");
  }

  document.getElementById("openPrefsBtn")?.addEventListener("click", openPrefs);
  document.getElementById("closePrefsBtn")?.addEventListener("click", closePrefs);

  document.getElementById("savePrefsBtn")?.addEventListener("click", () => {
    const prefs = {
      weightKg: Number(document.getElementById("prefWeight").value) || 75,
      kiteM2: Number(document.getElementById("prefKite").value) || 12,
      discipline: document.getElementById("prefDiscipline").value || "tt",
      minWind: (() => {
        const v = Number(document.getElementById("prefMinWind").value);
        return Number.isFinite(v) && v > 0 ? v : null;
      })()
    };
    savePrefs(prefs);
    closePrefs();
    fetchLiveData(); // רענון כדי לעדכן מד החלטה מיד
  });

  document.getElementById("resetPrefsBtn")?.addEventListener("click", () => {
    savePrefs({ ...defaultPrefs });
    openPrefs();
  });

  // ===== Chart.js: Wind zones plugin (knots) =====
  const windZonesPlugin = {
    id: 'windZones',
    beforeDraw(chart) {
      const { ctx, chartArea, scales } = chart;
      if (!chartArea) return;
      const y = scales.y;
      if (!y) return;

      const zones = [
        { from: 0,  to: 10, color: 'rgba(148,163,184,0.16)' },
        { from: 10, to: 15, color: 'rgba(34,197,94,0.14)'  },
        { from: 15, to: 20, color: 'rgba(59,130,246,0.13)' },
        { from: 20, to: 25, color: 'rgba(245,158,11,0.13)' },
        { from: 25, to: 60, color: 'rgba(239,68,68,0.11)'  }
      ];

      ctx.save();
      ctx.beginPath();
      ctx.rect(chartArea.left, chartArea.top, chartArea.right - chartArea.left, chartArea.bottom - chartArea.top);
      ctx.clip();

      zones.forEach(z => {
        const yTop = y.getPixelForValue(z.to);
        const yBottom = y.getPixelForValue(z.from);
        ctx.fillStyle = z.color;
        ctx.fillRect(chartArea.left, yTop, chartArea.right - chartArea.left, yBottom - yTop);
      });

      ctx.restore();
    }
  };

  let windChartInstance = null;

  const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
  const setRot = (id, deg) => { const el = document.getElementById(id); if (el) el.style.transform = `rotate(${deg}deg)`; };

  function msToKnots(ms){ return (ms * KNOTS); }
  function msToKnots1(ms){ return (ms * KNOTS).toFixed(1); }

  function getDir(deg){
    const dirs = ['צפון','צפון-מזרח','מזרח','דרום-מזרח','דרום','דרום-מערב','מערב','צפון-מערב'];
    return dirs[Math.round(deg / 45) % 8];
  }

  function formatIsraelTime(date){
    return date.toLocaleTimeString('he-IL', {
      timeZone: ISRAEL_TZ,
      hour: '2-digit', minute: '2-digit', second: '2-digit',
      hour12: false
    });
  }

  // vector mean direction
  function meanDirectionDeg(degWeights){
    let x = 0, y = 0;
    degWeights.forEach(({deg, w}) => {
      const rad = deg * Math.PI / 180;
      x += Math.cos(rad) * w;
      y += Math.sin(rad) * w;
    });
    if (x === 0 && y === 0) return 0;
    return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
  }

  // Clock
  setInterval(() => {
    const el = document.getElementById('israelTime');
    if (el) el.textContent = formatIsraelTime(new Date());
  }, 1000);

  function setIntervalMode(mode){
    state.currentInterval = mode;
    document.getElementById('btn-1min').classList.toggle('active', mode === '1min');
    document.getElementById('btn-15min').classList.toggle('active', mode === '15min');
    renderHistory();
  }

  function ensureChart(){
    if (windChartInstance) return;

    const ctx = document.getElementById('windChart');

    windChartInstance = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [
          {
            label: 'רוח (קשר)',
            data: [],
            tension: 0.25,
            borderWidth: 2,
            pointRadius: 0,
            fill: true,
            backgroundColor: (context) => {
              const { chart } = context;
              const { ctx, chartArea } = chart;
              if (!chartArea) return 'rgba(2,132,199,0.10)';
              const g = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
              g.addColorStop(0, 'rgba(2,132,199,0.26)');
              g.addColorStop(1, 'rgba(2,132,199,0.02)');
              return g;
            }
          },
          {
            label: 'משבים (קשר)',
            data: [],
            tension: 0.25,
            borderWidth: 2,
            pointRadius: 0,
            borderDash: [6,4],
            fill: false
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: true, labels: { boxWidth: 14, boxHeight: 2 } },
          tooltip: {
            callbacks: {
              label: (ctx) => `${ctx.dataset.label}: ${Number(ctx.raw).toFixed(1)}`
            }
          }
        },
        scales: {
          x: { ticks: { maxTicksLimit: 8 }, grid: { display: false } },
          y: { beginAtZero: true, title: { display: true, text: 'קשר' }, grid: { color: 'rgba(15,23,42,0.08)' } }
        }
      },
      plugins: [windZonesPlugin]
    });
  }

  function aggregateEvery15(readings){
    const out = [];
    for (let i = 0; i < readings.length; i += 15){
      const chunk = readings.slice(i, i + 15);
      if (!chunk.length) continue;

      const dirMean = meanDirectionDeg(chunk.map(r => ({ deg: r.deg, w: 1 })));

      out.push({
        timestamp: chunk[Math.floor(chunk.length/2)].timestamp,
        speed: chunk.reduce((a,b)=>a + b.speed, 0) / chunk.length,
        deg: dirMean,
        gust: chunk.reduce((a,b)=>a + b.gust, 0) / chunk.length,
        wave: chunk.reduce((a,b)=>a + (b.wave ?? 0), 0) / chunk.length,
        waterTemp: chunk.reduce((a,b)=>a + (b.waterTemp ?? 0), 0) / chunk.length
      });
    }
    return out;
  }

  async function fetchOpenMeteoHistory(lat, lon, hoursBack = 24){
    const url =
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
      `&hourly=wind_speed_10m,wind_direction_10m,wind_gusts_10m` +
      `&past_days=2&forecast_days=1&timezone=${encodeURIComponent(ISRAEL_TZ)}`;

    const r = await fetch(url);
    const j = await r.json();
    const h = j.hourly || {};
    const times = h.time || [];
    const sp = h.wind_speed_10m || [];
    const gd = h.wind_direction_10m || [];
    const gu = h.wind_gusts_10m || [];

    const now = Date.now();
    const cutoff = now - hoursBack * 60 * 60 * 1000;

    const kmhToMs = (k) => (Number(k || 0) / 3.6);

    const out = [];
    for (let i = 0; i < times.length; i++){
      const ts = new Date(times[i]).getTime();
      if (!Number.isFinite(ts)) continue;
      if (ts < cutoff || ts > now) continue;

      out.push({
        timestamp: new Date(ts),
        speed: kmhToMs(sp[i]),
        gust: kmhToMs(gu[i] ?? sp[i]),
        deg: Number(gd[i] ?? 0),
        wave: null,
        waterTemp: null,
        temp: null
      });
    }
    return out;
  }
  async function fetchOpenMeteoPoint(lat, lon){
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=wind_speed_10m,wind_direction_10m,wind_gusts_10m`;
    const r = await fetch(url);
    const j = await r.json();
    const c = j.current || {};

    // Open-Meteo returns km/h
    const kmhToMs = (k) => (Number(k || 0) / 3.6);

    return {
      speed: kmhToMs(c.wind_speed_10m ?? 0),
      deg: Number(c.wind_direction_10m ?? 0),
      gust: kmhToMs(c.wind_gusts_10m ?? c.wind_speed_10m ?? 0)
    };
  }

  async function fetchMETAR_LLBG(){
    const r = await fetch(`https://aviationweather.gov/api/data/metar?ids=LLBG&format=json`);
    const arr = await r.json();
    const m = arr && arr[0] ? arr[0] : null;
    if (!m) return null;

    const wspd = Number(m.wspd ?? 0);
    const wgst = (m.wgst != null) ? Number(m.wgst) : null;
    const wdir = Number(m.wdir ?? 0);

    const knotsToMs = (k) => k * 0.514444;

    return {
      speed: knotsToMs(wspd),
      gust: knotsToMs(wgst ?? wspd * 1.3),
      deg: wdir
    };
  }

  function parseWaveRangeFromText(text){
    const re = /גובה\s*הגלים\s*:\s*(\d+)\s*[-–]\s*(\d+)\s*ס["״]?מ/;
    const m = text.match(re);
    if (!m) return null;
    const minCm = Number(m[1]);
    const maxCm = Number(m[2]);
    if (!isFinite(minCm) || !isFinite(maxCm) || minCm <= 0 || maxCm <= 0) return null;
    return { minCm, maxCm };
  }

  async function fetchTlvSeaWaveRange(){
    try{
      const r = await fetch(TLV_SEA_PAGE, { mode: 'cors' });
      const t = await r.text();
      const range = parseWaveRangeFromText(t);
      if (range) return { ...range, source: 'עיריית ת״א' };
    }catch(e){}

    try{
      const r = await fetch(JINA_PROXY(TLV_SEA_PAGE));
      const t = await r.text();
      const range = parseWaveRangeFromText(t);
      if (range) return { ...range, source: 'עיריית ת״א' };
    }catch(e){}

    return null;
  }

  async function fetchWaveFallbackOpenMeteoMarine(){
    const url = `https://marine-api.open-meteo.com/v1/marine?latitude=${WAVE_COORDS.lat}&longitude=${WAVE_COORDS.lon}&current=wave_height,sea_surface_temperature&timezone=Asia/Jerusalem`;
    const r = await fetch(url);
    const j = await r.json();
    return {
      wave: j.current?.wave_height ?? 0.6,
      waterTemp: j.current?.sea_surface_temperature ?? 23
    };
  }

  async function fetchLiveData(){
    const refreshIcon = document.getElementById('refreshIcon');
    if (refreshIcon) refreshIcon.classList.add('fa-spin');

    // --- OWM coastal points ---
    const owmPromises = windSensorsOWM.map(s =>
      fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${s.lat}&lon=${s.lon}&appid=${OWM_API_KEY}&units=metric&lang=he`)
        .then(r => r.json())
        .then(data => ({
          speed: Number(data.wind?.speed ?? 0),
          deg: Number(data.wind?.deg ?? 0),
          gust: Number(data.wind?.gust ?? ((data.wind?.speed ?? 0) * 1.2)),
          temp: Number(data.main?.temp ?? 0)
        }))
        .catch(() => ({ speed: 0, deg: 0, gust: 0, temp: 0 }))
    );

    // --- Open-Meteo points ---
    const omPromises = [
      fetchOpenMeteoPoint(openMeteoPoints.herzliya.lat, openMeteoPoints.herzliya.lon),
      fetchOpenMeteoPoint(openMeteoPoints.batyam.lat, openMeteoPoints.batyam.lon),
      fetchOpenMeteoPoint(openMeteoPoints.rishon.lat, openMeteoPoints.rishon.lon)
    ].map(p => p.catch(() => ({ speed: 0, deg: 0, gust: 0 })));

    // --- METAR LLBG ---
    const metarPromise = fetchMETAR_LLBG().catch(() => null);

    // --- Waves: municipality preferred ---
    const tlvWavePromise = fetchTlvSeaWaveRange().catch(() => null);

    const [owmResults, omResults, metar, tlvWave] = await Promise.all([
      Promise.all(owmPromises),
      Promise.all(omPromises),
      metarPromise,
      tlvWavePromise
    ]);

    // Update per-coast sensors UI (speed, gust, dir)
    setText('speed1', msToKnots1(owmResults[0]?.speed ?? 0));
    setText('gust1',  msToKnots1(owmResults[0]?.gust ?? 0));
    setRot('dirIcon1', owmResults[0]?.deg ?? 0);

    setText('speed2', msToKnots1(owmResults[1]?.speed ?? 0));
    setText('gust2',  msToKnots1(owmResults[1]?.gust ?? 0));
    setRot('dirIcon2', owmResults[1]?.deg ?? 0);

    setText('speed3', msToKnots1(owmResults[2]?.speed ?? 0));
    setText('gust3',  msToKnots1(owmResults[2]?.gust ?? 0));
    setRot('dirIcon3', owmResults[2]?.deg ?? 0);

    // Open-Meteo cards
    setText('omHerzliya', msToKnots1(omResults[0]?.speed ?? 0));
    setText('omHerzliyaGust', msToKnots1(omResults[0]?.gust ?? 0));
    setRot('omHerzliyaDir', omResults[0]?.deg ?? 0);

    setText('omBatYam', msToKnots1(omResults[1]?.speed ?? 0));
    setText('omBatYamGust', msToKnots1(omResults[1]?.gust ?? 0));
    setRot('omBatYamDir', omResults[1]?.deg ?? 0);

    setText('omRishon', msToKnots1(omResults[2]?.speed ?? 0));
    setText('omRishonGust', msToKnots1(omResults[2]?.gust ?? 0));
    setRot('omRishonDir', omResults[2]?.deg ?? 0);

    // METAR card
    if (metar){
      setText('metarLLBG', msToKnots1(metar.speed));
      setText('metarLLBGGust', msToKnots1(metar.gust));
      setRot('metarLLBGDir', metar.deg ?? 0);
    } else {
      setText('metarLLBG', '--');
      setText('metarLLBGGust', '--');
      setRot('metarLLBGDir', 0);
    }

    // Water temp + wave height:
    let waveMeters = null;
    let waveRangeText = null;
    let waterTemp = null;

    if (tlvWave){
      const { minCm, maxCm } = tlvWave;
      const avgCm = (minCm + maxCm) / 2;
      waveMeters = avgCm / 100;
      waveRangeText = `טווח מדווח: ${minCm}–${maxCm} ס״מ`;
      setText('waveSourceBadge', tlvWave.source);
    } else {
      setText('waveSourceBadge', 'מודל');
      try{
        const marine = await fetchWaveFallbackOpenMeteoMarine();
        waveMeters = marine.wave ?? 0.6;
        waterTemp = marine.waterTemp ?? 23;
        waveRangeText = 'טווח: לא זמין (מציג הערכה מודלית)';
      } catch(e){
        waveMeters = 0.6;
        waveRangeText = 'טווח: לא זמין';
      }
    }

    if (waterTemp == null){
      try{
        const marine = await fetchWaveFallbackOpenMeteoMarine();
        waterTemp = marine.waterTemp ?? 23;
      } catch(e){
        waterTemp = 23;
      }
    }

    setText('waveHeight', Number(waveMeters ?? 0.6).toFixed(1));
    setText('waveRangeText', waveRangeText || '--');
    setText('waterTempMain', Number(waterTemp).toFixed(0) + '°');
    setText('waterTempSide', Number(waterTemp).toFixed(0) + '°');

    // Weighted blend (wind)
    const parts = [];

    // OWM points (3) -> coastal dominates
    const wOWM = 0.18; // each -> 0.54 total
    owmResults.forEach(r => parts.push({ speed: r.speed, gust: r.gust, deg: r.deg, w: wOWM }));

    // Open-Meteo (3) -> support
    const wOM = 0.10;  // each -> 0.30 total
    omResults.forEach(r => parts.push({ speed: r.speed, gust: r.gust, deg: r.deg, w: wOM }));

    // METAR -> stabilizer
    if (metar) parts.push({ speed: metar.speed, gust: metar.gust, deg: metar.deg, w: 0.16 });

    const totalW = parts.reduce((a,b)=>a + b.w, 0) || 1;

    const avgSpeed = parts.reduce((a,b)=>a + b.speed*b.w, 0) / totalW;
    const avgGust  = parts.reduce((a,b)=>a + b.gust*b.w, 0) / totalW;
    const avgDeg   = meanDirectionDeg(parts.map(p => ({ deg: p.deg, w: p.w })));

    // Decision + Confidence (based on sensors)
    const nowTs = Date.now();
    const sensors = [];

    // OWM 3
    sensors.push({ name: "OWM הילטון", avgKnots: msToKnots(owmResults[0]?.speed ?? 0), ts: nowTs });
    sensors.push({ name: "OWM קלור",   avgKnots: msToKnots(owmResults[1]?.speed ?? 0), ts: nowTs });
    sensors.push({ name: "OWM יפו",    avgKnots: msToKnots(owmResults[2]?.speed ?? 0), ts: nowTs });

    // OM 3
    sensors.push({ name: "OM הרצליה", avgKnots: msToKnots(omResults[0]?.speed ?? 0), ts: nowTs });
    sensors.push({ name: "OM בת ים",  avgKnots: msToKnots(omResults[1]?.speed ?? 0), ts: nowTs });
    sensors.push({ name: "OM ראשלצ",  avgKnots: msToKnots(omResults[2]?.speed ?? 0), ts: nowTs });

    // METAR
    if (metar){
      sensors.push({ name: "METAR LLBG", avgKnots: msToKnots(metar.speed ?? 0), ts: nowTs });
    }

    const prefs = loadPrefs();
    const fusedAvgKnots = msToKnots(avgSpeed);

    const dc = computeDecisionAndConfidence({
      fusedAvgKnots,
      sensors,
      nowTs,
      prefs
    });
    renderDecisionBar(dc);

    // Store reading
    const reading = {
      timestamp: new Date(),
      speed: avgSpeed,
      gust: avgGust,
      deg: avgDeg,
      wave: waveMeters ?? 0.6,
      waterTemp: waterTemp ?? 23,
      temp: (owmResults[0]?.temp ?? 0)
    };

    state.readings.push(reading);
    state.liveCount += 1;

    // Default to 15min until we have 60 live points
    if (state.liveCount < 60){
      state.currentInterval = "15min";
      document.getElementById('btn-1min').classList.toggle('active', false);
      document.getElementById('btn-15min').classList.toggle('active', true);
    }

    if (state.readings.length > 1440) state.readings.shift();

    // Update main UI
    setText('currentSpeed', msToKnots1(avgSpeed));
    setText('windDir', getDir(avgDeg));
    setText('windGust', msToKnots1(avgGust));
    setText('temp', (reading.temp ?? 0).toFixed(0) + '°');

    const arrow = document.getElementById('compassArrow');
    if (arrow) arrow.style.transform = `translateX(-50%) rotate(${avgDeg}deg)`;

    if (refreshIcon) refreshIcon.classList.remove('fa-spin');

    renderHistory();
  }

  function renderHistory(){
    if (!state.readings.length) return;

    const last24h = state.readings.filter(r => (new Date() - r.timestamp) / (1000*60*60) <= 24);
    let dataToShow = (state.currentInterval === '15min') ? aggregateEvery15(last24h) : last24h;
    if (!dataToShow.length) return;

    ensureChart();

    const labels = dataToShow.map(p => p.timestamp.toLocaleTimeString('he-IL', {
      timeZone: ISRAEL_TZ, hour:'2-digit', minute:'2-digit', hour12:false
    }));

    const speedKn = dataToShow.map(p => Number((p.speed * KNOTS).toFixed(2)));
    const gustKn  = dataToShow.map(p => Number((p.gust  * KNOTS).toFixed(2)));

    windChartInstance.data.labels = labels;
    windChartInstance.data.datasets[0].data = speedKn;
    windChartInstance.data.datasets[1].data = gustKn;
    windChartInstance.update('none');

    const table = document.getElementById('recentHoursTable');
    const recent = dataToShow.slice(-20).reverse();

    table.innerHTML = recent.map(p => {
      const timeStr = p.timestamp.toLocaleTimeString('he-IL', {
        timeZone: ISRAEL_TZ, hour:'2-digit', minute:'2-digit', hour12:false
      });

      const waveCell = (p.wave == null) ? '--' : Number(p.wave).toFixed(1);
      const waterCell = (p.waterTemp == null) ? '--' : (Number(p.waterTemp).toFixed(0) + '°');

      return `
        <tr class="border-b border-slate-200 hover:bg-slate-50">
          <td class="whitespace-nowrap font-mono text-slate-700">${timeStr}</td>
          <td class="font-extrabold text-slate-900">${(p.speed*KNOTS).toFixed(1)}</td>
          <td class="font-extrabold text-orange-600">${(p.gust*KNOTS).toFixed(1)}</td>
          <td class="text-center">
            <i class="fas fa-arrow-up text-sky-700" title="${getDir(p.deg)}"
               style="transform: rotate(${p.deg}deg); display:inline-block;"></i>
          </td>
          <td class="whitespace-nowrap text-amber-700 font-bold">${waveCell}</td>
          <td class="whitespace-nowrap text-teal-700 font-bold">${waterCell}</td>
        </tr>
      `;
    }).join('');
  }

  // Start
  (async () => {
    // Seed history from Bat Yam (Open-Meteo hourly)
    const hist = await fetchOpenMeteoHistory(openMeteoPoints.batyam.lat, openMeteoPoints.batyam.lon, 24)
      .catch(() => []);

    if (hist.length){
      state.readings = hist;
      // עדיף להתחיל ב-15 דקות כשיש היסטוריה שהיא hourly
      state.currentInterval = "15min";
      document.getElementById('btn-1min').classList.toggle('active', false);
      document.getElementById('btn-15min').classList.toggle('active', true);
      renderHistory();
    }

    await fetchLiveData();
    setInterval(fetchLiveData, 60000);
  })();

  window.addEventListener('resize', () => {
    if (windChartInstance) windChartInstance.resize();
  });
</script>
</body>
</html>
