<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>×ª×œ ××‘×™×‘ ×§×™×™×˜</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    * { font-family: 'Assistant', sans-serif; }
    body { background: linear-gradient(180deg, #f0f9ff, #e0f2fe); min-height: 100vh; }
    .card { background: white; border-radius: 20px; box-shadow: 0 4px 20px rgba(2,132,199,0.08); }
    .badge { font-size: 0.75rem; background: rgba(2,132,199,0.1); color: #0284c7; padding: 0.25rem 0.75rem; border-radius: 999px; font-weight: 700; }
    .badge.ims { background: rgba(124,58,237,0.1); color: #7c3aed; }
    .btn { background: rgba(2,132,199,0.1); border: 1px solid rgba(2,132,199,0.25); color: #0284c7; padding: 0.5rem 1rem; border-radius: 12px; font-weight: 700; cursor: pointer; }
    .compass { width: 160px; height: 160px; border-radius: 50%; border: 3px solid #cbd5e1; background: linear-gradient(145deg, #f8fafc, #f1f5f9); position: relative; margin: 0 auto; }
    .compass-arrow { position: absolute; bottom: 50%; left: 50%; width: 6px; height: 60px; background: linear-gradient(to top, #0ea5e9, #0284c7); transform-origin: bottom center; transform: translateX(-50%) rotate(0deg); transition: transform 0.8s; border-radius: 999px; }
    .sensor-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 1rem; }
    .sensor-card.ims { border-color: rgba(124,58,237,0.3); background: rgba(124,58,237,0.03); }
    .sensor-speed { font-size: 1.8rem; font-weight: 900; color: #0369a1; }
    .sensor-card.ims .sensor-speed { color: #7c3aed; }
    .decision-bar { border-right: 4px solid #cbd5e1; }
    .decision-bar.green { border-right-color: #22c55e; }
    .decision-bar.yellow { border-right-color: #f59e0b; }
    .decision-bar.red { border-right-color: #ef4444; }
    .chart-shell { background: #f8fafc; border-radius: 16px; height: 300px; padding: 16px; }
    .modal { position: fixed; inset: 0; background: rgba(15,23,42,0.6); display: flex; align-items: center; justify-content: center; padding: 20px; z-index: 50; opacity: 0; visibility: hidden; }
    .modal.visible { opacity: 1; visibility: visible; }
  </style>
</head>
<body class="px-4 py-6">

<header class="max-w-6xl mx-auto mb-6">
  <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
    <div>
      <h1 class="text-3xl font-extrabold text-slate-800"><i class="fas fa-wind text-sky-600 ml-2"></i>×ª×œ ××‘×™×‘ ×§×™×™×˜</h1>
      <div class="flex items-center gap-3 mt-2">
        <span class="badge"><span class="w-2 h-2 rounded-full bg-emerald-500 inline-block ml-1"></span>LIVE</span>
        <span class="badge ims"><i class="fas fa-building-columns ml-1"></i>IMS</span>
        <span class="text-sm text-slate-500 font-mono" id="israelTime">--:--:--</span>
      </div>
    </div>
    <button onclick="fetchAllData()" class="btn" id="refreshBtn"><i class="fas fa-rotate mr-2" id="refreshIcon"></i>×¨×¢× ×•×Ÿ</button>
  </div>
</header>

<section class="max-w-6xl mx-auto mb-6">
  <div id="decisionBar" class="card p-5 decision-bar red">
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
      <div class="flex items-center gap-4">
        <div id="goLight" class="w-5 h-5 rounded-full bg-red-500 shadow-lg"></div>
        <div>
          <div id="goTitle" class="text-xl font-extrabold">×˜×•×¢×Ÿ...</div>
          <div id="goSubtitle" class="text-sm text-slate-500">×××ª×™×Ÿ ×œ× ×ª×•× ×™×</div>
        </div>
      </div>
      <div class="text-right">
        <div class="text-xs text-slate-400 mb-1">×××•×Ÿ ×‘××“×™×“×”</div>
        <div class="flex items-center gap-2">
          <div class="w-24 h-2 bg-slate-200 rounded-full"><div id="confidenceBar" class="h-full bg-purple-500 transition-all" style="width: 0%"></div></div>
          <span id="confidenceScore" class="font-bold">--%</span>
        </div>
      </div>
    </div>
  </div>
</section>

<main class="max-w-6xl mx-auto space-y-6">

<section class="card p-6">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <div class="lg:col-span-2">
      <p class="text-sm text-slate-500 mb-2">××”×™×¨×•×ª ×¨×•×— ×××•×¦×¢×ª</p>
      <div class="flex items-baseline gap-3">
        <span id="currentSpeed" class="text-7xl font-extrabold text-sky-700">--</span>
        <span class="text-2xl font-bold text-slate-400">×§×©×¨</span>
      </div>
      <div class="grid grid-cols-4 gap-4 mt-6">
        <div class="bg-sky-50 rounded-xl p-3 text-center">
          <p class="text-xs text-sky-600 font-bold">×›×™×•×•×Ÿ</p>
          <p id="windDir" class="text-xl font-extrabold">--</p>
        </div>
        <div class="bg-orange-50 rounded-xl p-3 text-center">
          <p class="text-xs text-orange-600 font-bold">××©×‘×™×</p>
          <p id="windGust" class="text-xl font-extrabold text-orange-600">--</p>
        </div>
        <div class="bg-teal-50 rounded-xl p-3 text-center">
          <p class="text-xs text-teal-600 font-bold">××™×</p>
          <p id="waterTempMain" class="text-xl font-extrabold text-teal-700">--</p>
        </div>
        <div class="bg-slate-50 rounded-xl p-3 text-center">
          <p class="text-xs text-slate-600 font-bold">×—×•×£</p>
          <p id="temp" class="text-xl font-extrabold">--</p>
        </div>
      </div>
    </div>
    <div class="flex items-center justify-center">
      <div class="compass">
        <div class="compass-arrow" id="compassArrow"></div>
      </div>
    </div>
  </div>
</section>

<section class="card p-6 border-2 border-purple-200 bg-purple-50/30">
  <h2 class="text-xl font-extrabold mb-4"><i class="fas fa-building-columns text-purple-600 ml-2"></i>×ª×—× ×•×ª IMS</h2>
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="imsGrid">
    <!-- IMS stations -->
  </div>
</section>

<section class="card p-6">
  <h2 class="text-xl font-extrabold mb-4"><i class="fas fa-network-wired text-slate-600 ml-2"></i>×—×™×™×©× ×™× × ×•×¡×¤×™×</h2>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="secondaryGrid">
    <!-- Secondary -->
  </div>
</section>

<section class="card p-6">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-xl font-extrabold"><i class="fas fa-chart-line text-sky-600 ml-2"></i>×”×™×¡×˜×•×¨×™×”</h2>
    <div class="flex gap-2">
      <button onclick="setIntervalMode('15min')" class="px-3 py-1 rounded-full bg-slate-200 text-sm font-bold" id="btn-15min">15 ×“×§×•×ª</button>
    </div>
  </div>
  <div class="chart-shell mb-4">
    <canvas id="windChart"></canvas>
  </div>
  <div class="overflow-x-auto">
    <table class="w-full text-right text-sm">
      <thead class="text-slate-500 border-b">
        <tr><th>×©×¢×”</th><th>×¨×•×—</th><th>××©×‘×™×</th><th>×›×™×•×•×Ÿ</th></tr>
      </thead>
      <tbody id="historyTable"></tbody>
    </table>
  </div>
</section>

</main>

<script>
const CONFIG = {
  OWM_API_KEY: '0429ca60a348cdac63a6cc4547a6837d',
  KNOTS: 1.94384,
  PROXY_URL: 'https://ims-proxy-9t4ci9ywv-shaigazit-uxs-projects.vercel.app/api/ims',
  IMS_STATIONS: {
    herzliya: 11,
    batYam: 16,
    telAvivCoast: 44,
    central: 64
  }
};

const $ = id => document.getElementById(id);
const msToKnots = ms => ms * CONFIG.KNOTS;
const msToKnotsStr = ms => msToKnots(ms).toFixed(1);
const kmhToMs = kmh => kmh / 3.6;

function getDir(deg) {
  const dirs = ['×¦×¤×•×Ÿ', '×¦×¤×•×Ÿ-××–×¨×—', '××–×¨×—', '×“×¨×•×-××–×¨×—', '×“×¨×•×', '×“×¨×•×-××¢×¨×‘', '××¢×¨×‘', '×¦×¤×•×Ÿ-××¢×¨×‘'];
  return dirs[Math.round(deg / 45) % 8];
}

function formatTime(date) {
  return date.toLocaleTimeString('he-IL', { timeZone: 'Asia/Jerusalem', hour: '2-digit', minute: '2-digit', second: '2-digit' });
}

const sensorDefs = {
  ims: [
    { id: 'ims11', stationId: 11, name: '×”×¨×¦×œ×™×” ××¨×™× ×”', region: '×¦×¤×•×Ÿ', weight: 0.25 },
    { id: 'ims16', stationId: 16, name: '×‘×ª ×™×', region: '×“×¨×•×', weight: 0.25 },
    { id: 'ims44', stationId: 44, name: '×ª×œ ××‘×™×‘ ×—×•×£', region: '××¨×›×–', weight: 0.30 },
    { id: 'ims64', stationId: 64, name: '××¨×›×– ×”××¨×¥', region: '×‘×™×ª ×“×’×Ÿ', weight: 0.20 }
  ],
  owm: [{ id: 'hilton', lat: 32.1101, lon: 34.7795, name: '×”×™×œ×˜×•×Ÿ', weight: 0.10 }],
  openmeteo: [
    { id: 'herzliya', lat: 32.1656, lon: 34.8368, name: '×”×¨×¦×œ×™×” OM', weight: 0.05 },
    { id: 'batyam', lat: 32.0167, lon: 34.7500, name: '×‘×ª ×™× OM', weight: 0.05 }
  ]
};

const state = {
  readings: [],
  imsData: {},
  sensorData: {}
};

async function fetchIMSData(stationId) {
  try {
    const response = await fetch(`${CONFIG.PROXY_URL}?stationId=${stationId}`);
    if (!response.ok) return null;
    const data = await response.json();
    return parseIMS(data);
  } catch (error) {
    console.error('IMS error:', error);
    return null;
  }
}

function parseIMS(data) {
  if (!data?.data?.[0]) return null;
  const latest = data.data[0];
  const channels = latest.channels || [];
  const result = { timestamp: new Date(latest.datetime || Date.now()) };
  
  const ws = channels.find(c => c.id === 'WS');
  const wd = channels.find(c => c.id === 'WD');
  const wsm = channels.find(c => c.id === 'WSMAX');
  const td = channels.find(c => c.id === 'TD');
  
  if (ws) result.speed = parseFloat(ws.value);
  if (wd) result.deg = parseFloat(wd.value);
  if (wsm) result.gust = parseFloat(wsm.value);
  if (td) result.temp = parseFloat(td.value);
  if (!result.gust && result.speed) result.gust = result.speed * 1.3;
  
  return result;
}

async function fetchOWM(lat, lon) {
  const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${CONFIG.OWM_API_KEY}&units=metric`;
  const res = await fetch(url);
  const data = await res.json();
  return {
    speed: data.wind?.speed || 0,
    deg: data.wind?.deg || 0,
    gust: data.wind?.gust || data.wind?.speed * 1.2,
    temp: data.main?.temp,
    timestamp: Date.now()
  };
}

async function fetchOpenMeteo(lat, lon) {
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=wind_speed_10m,wind_direction_10m,wind_gusts_10m`;
  const res = await fetch(url);
  const data = await res.json();
  const c = data.current;
  return {
    speed: kmhToMs(c.wind_speed_10m),
    deg: c.wind_direction_10m,
    gust: kmhToMs(c.wind_gusts_10m || c.wind_speed_10m),
    timestamp: Date.now()
  };
}

function renderCard(sensor, data, isIMS) {
  if (!data || !data.speed) return '';
  const speed = msToKnotsStr(data.speed);
  const gust = msToKnotsStr(data.gust || data.speed * 1.2);
  const cls = isIMS ? 'sensor-card ims' : 'sensor-card';
  const icon = isIMS ? 'fa-building-columns' : 'fa-location-dot';
  return `
    <div class="${cls}">
      <div class="flex justify-between items-center mb-2">
        <span class="font-bold text-sm"><i class="fas ${icon} ml-1 ${isIMS ? 'text-purple-600' : 'text-slate-600'}"></i>${sensor.name}</span>
      </div>
      <div class="sensor-speed">${speed} <span class="text-sm text-slate-500">×§×©×¨</span></div>
      <div class="text-xs text-slate-500 mt-1">××©×‘×™×: ${gust} | ${getDir(data.deg || 0)}</div>
    </div>
  `;
}

async function fetchAllData() {
  const btn = $('refreshBtn');
  const icon = $('refreshIcon');
  btn.disabled = true;
  icon.classList.add('fa-spin');

  const readings = [];
  
  // Fetch IMS
  for (const s of sensorDefs.ims) {
    const data = await fetchIMSData(s.stationId);
    if (data) {
      state.imsData[s.id] = data;
      readings.push({ source: 'ims', ...data, weight: s.weight });
    }
  }
  
  // Fetch OWM
  for (const s of sensorDefs.owm) {
    try {
      const data = await fetchOWM(s.lat, s.lon);
      state.sensorData[s.id] = data;
      readings.push({ ...data, weight: s.weight });
    } catch (e) {}
  }
  
  // Fetch Open-Meteo
  for (const s of sensorDefs.openmeteo) {
    try {
      const data = await fetchOpenMeteo(s.lat, s.lon);
      state.sensorData[s.id] = data;
      readings.push({ ...data, weight: s.weight });
    } catch (e) {}
  }

  // Calculate average
  let totalSpeed = 0, totalGust = 0, totalDirX = 0, totalDirY = 0, totalW = 0;
  
  readings.forEach(r => {
    if (!r.speed) return;
    totalSpeed += r.speed * r.weight;
    totalGust += (r.gust || r.speed) * r.weight;
    const rad = (r.deg || 0) * Math.PI / 180;
    totalDirX += Math.cos(rad) * r.weight;
    totalDirY += Math.sin(rad) * r.weight;
    totalW += r.weight;
  });

  const avgSpeed = totalW > 0 ? totalSpeed / totalW : 0;
  const avgGust = totalW > 0 ? totalGust / totalW : 0;
  const avgDeg = totalW > 0 ? (Math.atan2(totalDirY, totalDirX) * 180 / Math.PI + 360) % 360 : 0;

  // Update UI
  $('currentSpeed').textContent = msToKnotsStr(avgSpeed);
  $('windDir').textContent = getDir(avgDeg);
  $('windGust').textContent = msToKnotsStr(avgGust);
  $('compassArrow').style.transform = `translateX(-50%) rotate(${avgDeg}deg)`;
  
  const tempSource = state.imsData['ims44'] || state.sensorData['hilton'];
  $('temp').textContent = tempSource?.temp ? `${Math.round(tempSource.temp)}Â°` : '--';

  // Render cards
  $('imsGrid').innerHTML = sensorDefs.ims.map(s => renderCard(s, state.imsData[s.id], true)).join('');
  $('secondaryGrid').innerHTML = [
    ...sensorDefs.owm.map(s => renderCard(s, state.sensorData[s.id], false)),
    ...sensorDefs.openmeteo.map(s => renderCard(s, state.sensorData[s.id], false))
  ].join('');

  // Decision
  const speedKnots = msToKnots(avgSpeed);
  const need = 15; // default
  let status = 'red', title = '×˜×•×‘ ×œ××˜×§×•×ª â˜•';
  if (speedKnots >= need + 1) { status = 'green'; title = '×¦× ×œ×—×•×£! ğŸ„'; }
  else if (speedKnots >= need - 1) { status = 'yellow'; title = '×’×‘×•×œ×™ âš ï¸'; }
  
  $('decisionBar').className = `card p-5 decision-bar ${status}`;
  $('goLight').className = `w-5 h-5 rounded-full shadow-lg ${status === 'green' ? 'bg-green-500' : status === 'yellow' ? 'bg-yellow-500' : 'bg-red-500'}`;
  $('goTitle').textContent = title;
  $('goSubtitle').textContent = `${speedKnots.toFixed(1)} ×§×©×¨ (×¦×¨×™×š ~${need})`;

  btn.disabled = false;
  icon.classList.remove('fa-spin');
}

function init() {
  setInterval(() => $('israelTime').textContent = formatTime(new Date()), 1000);
  fetchAllData();
  setInterval(fetchAllData, 60000);
}

init();
</script>
</body>
</html>
